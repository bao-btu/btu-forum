window.vBulletin=window.vBulletin||{};window.vBulletin.phrase=window.vBulletin.phrase||{};window.vBulletin.phrase.precache=window.vBulletin.phrase.precache||[];window.vBulletin.phrase.precache=$.merge(window.vBulletin.phrase.precache,["invalid_request","invalid_search_syntax","invalid_server_response_please_try_again","unknown_error"]);(function(A){vBulletin.conversation=vBulletin.conversation||{};vBulletin.conversation.filter=function(K){var N=this;var E=null;var F=0;var J=false;var C=false;var I="conversation_filter";var O={context:document,autoCheck:false,checkInterval:15000,scrollToTop:null,customFilter:null,onContentLoad:null,closeOverlayOnScroll:true,pagination:null,allowHistory:false,hash:""};if(K&&typeof K=="object"){A.extend(O,K)}var B=new vBulletin.history.instance(O.allowHistory);function H(){A(".toolbar-filter-overlay input[type=radio]",O.context).off("change."+I).on("change."+I,function(Y,X,c){var R,V,S=A(this),f=A(this.form);if(!B.isEnabled()&&O.allowHistory){R=vBulletin.makePaginatedUrl(location.href,1);location.href=vBulletin.makeFilterUrl(R,this.name,this.value,O.context,O.hash);return true}J=true;O.customFilter=null;if(!S.data("bypass-filter-display")){M(this)}V=S.closest(".conversation-toolbar-wrapper");if(A(".conversation-toolbar-wrapper",O.context).length>1){$toolbarWrappers.filter("."+(V.hasClass("top")?"bottom":"top")).find("input[name={0}][value={1}]".format(this.name,this.value)).prop("checked",true)}if(this.value=="conversations_on"){O.autoCheck=true;C=true;F=1}else{clearTimeout(F);C=(this.name=="filter_show")}A(".new-conversations-strip",O.context).hide();N.updatePageNumber(c||1);var U=A('.filtered-by .filter-text[data-filter-name="q"]',O.context);if(U.length){var Q=N.getSelectedFilters(f);Q.q=U.data("filter-value");N.setOption("customFilter",Q);N.forceApplyFilters()}else{N.applyFilters(false)}if(B.isEnabled()&&!X){var W=N.getSelectedFilters(f),d=this.name,P=this.value,b=A(".filtered-by",V),T=V.closest(".ui-tabs-panel").attr("id"),a={from:"filter",page:1,tab:T?"#"+T:"",filters:W,filtervalue:P,filtername:d};if(!b.data("reset")){R=vBulletin.makePaginatedUrl(location.href,1);R=vBulletin.makeFilterUrl(R,d,P,O.context)}else{R=location.pathname.replace(/\/page[0-9]+/,"");var Z=vBulletin.parseQueryString(location.search);if(Z.tab){R+="?tab="+Z.tab}else{if(Z.view){R+="?view="+Z.view}}}B.pushState(a,document.title,R);b.data("reset",null)}});A(".new-conversations-strip",O.context).off("click."+I).on("click."+I,function(){A(this).hide();C=true;N.updatePageNumber(1);N.applyFilters(false,true)});A(".toolbar-filter",O.context).off("click."+I).on("click."+I,function(U,T,R){var S=A(this).closest(".conversation-toolbar-wrapper");var Q=(S.hasClass("bottom"))?"bottom":"top";if(typeof T=="undefined"){T="slow"}var V=A(".filter-wrapper",this).toggleClass("selected");A(".arrow .vb-icon",this).toggleClass("vb-icon-triangle-down-wide vb-icon-triangle-up-wide");A(".toolbar-filter-overlay",S).slideToggle(T,function(){var W=I+Q;if(A(this).is(":visible")){A("body").off("click."+W).on("click."+W,function(c){var a=".conversation-toolbar-wrapper."+Q;if(A(c.target).closest(".toolbar-filter-overlay").length==0&&A(c.target).closest(".toolbar-filter").length==0){A("body").off("click."+W);A(window).off("scroll."+W);var b=(A(c.target).closest(".toolbar-filter").length>0)?"fast":"slow";A(".conversation-toolbar-wrapper.{0} .conversation-toolbar .toolbar-filter".format(Q),O.context).triggerHandler("click."+I,[b])}});var Y=true;if(R!="scroll"){var X=A(".filtered-by",O.context);if(X.length==0||X.is(":hidden")){X=this}var Z={};Y=vBulletin.isScrolledIntoView(X,Z);if(!Y){A("html,body").animate({scrollTop:"+="+Math.abs(Z.bottom)},"fast",function(){setTimeout(function(){if(O.closeOverlayOnScroll){A(window).off("scroll."+W).on("scroll."+W,function(){A(".conversation-toolbar-wrapper.{0} .conversation-toolbar .toolbar-filter".format(Q),O.context).triggerHandler("click."+I,[0,"scroll"])})}},50)})}}if(Y){if(O.closeOverlayOnScroll){A(window).off("scroll."+W).on("scroll."+W,function(){A(".conversation-toolbar-wrapper.{0} .conversation-toolbar .toolbar-filter".format(Q),O.context).triggerHandler("click."+I,[0,"scroll"])})}}}else{A("body").off("click."+W);A(window).off("scroll."+W)}});if(S.hasClass("bottom")&&A(".arrow .vb-icon",this).hasClass("vb-icon-triangle-up-wide")){var P=A(".conversation-toolbar-wrapper.bottom .toolbar-filter-overlay",O.context);A("html, body").animate({scrollTop:P.offset().top+P.innerHeight()},500)}});A(".filtered-by",O.context).off("click."+I,".x").on("click."+I,".x",function(){var V=A(this),W=V.closest(".filtered-by"),X=V.closest(".filter-text"),T=X.data("filter-name"),U=A(),P;W.data("clicked",true);if(!B.isEnabled()&&O.allowHistory){var Q;if(X.data("filter-type")=="text"&&X.data("filter-js-selector")){Q=vBulletin.makePaginatedUrl(location.href,1);location.href=vBulletin.makeFilterUrl(Q,"q","",O.context,O.hash,true)}else{Q=vBulletin.makePaginatedUrl(location.href,1);location.href=vBulletin.makeFilterUrl(Q,T,X.data("filter-value"),O.context,O.hash,true)}return false}U=A(".toolbar-filter-overlay .filter-options input[name={0}]".format(T),O.context).prop("checked",false).filter(".js-default-checked");N.updatePageNumber(1);if(X.data("filter-type")=="text"&&X.data("filter-js-selector")){A(X.data("filter-js-selector")).val("");P=N.getSelectedFilters(A("form.toolbar-filter-overlay",O.context));delete P[T];N.setOption("customFilter",P)}X.remove();var S=W.find(".filter-text").length;if(S==0){W.addClass("h-hide");W.data("reset",true)}else{if(S==1){W.find(".clear-all").addClass("h-hide")}}if(U.length==1){U.data("bypass-filter-display",true);U.trigger("click."+I);U.data("bypass-filter-display",null)}else{if(P){var Q=vBulletin.makePaginatedUrl(location.href,1),R=V.closest(".ui-tabs-panel").attr("id");Q=vBulletin.makeFilterUrl(Q,"q","",O.context);B.pushState({from:"filter",page:1,tab:R?"#"+R:"",filters:P},document.title,Q)}N.forceApplyFilters();if(P){N.setOption("customFilter",null)}}});A(".filtered-by",O.context).off("click."+I,".clear-all").on("click."+I,".clear-all",function(){var P=A(this).closest(".conversation-toolbar-wrapper");A(this).data("clicked",true);N.setOption("customFilter",null);N.resetFilters(false,false,P);return false});A(".conversation-toolbar .filter-wrapper",O.context).data("object-instance",N);A(".conversation-showmore",O.context).click(function(){var P=parseInt(A('form.toolbar-filter-overlay input[name="pagenum"]',O.context).val());C=false;N.updatePageNumber(P+1);N.applyFilters(false,true,true)});A(".conversation-toolbar .toolbar-search-form",O.context).off("submit.filtersearch").on("submit.filtersearch",function(){var P="q";$searchBox=A(this.elements[P]),searchKeyword=A.trim($searchBox.val()),$conversationToolbar=A(this).closest(".conversation-toolbar-wrapper"),Q;$searchBox.val(searchKeyword);if(!B.isEnabled()&&O.allowHistory){Q=vBulletin.makePaginatedUrl(location.href,1);location.href=vBulletin.makeFilterUrl(Q,P,searchKeyword,$conversationToolbar);return false}var S=A(this).closest(".ui-tabs-panel").attr("id");if(searchKeyword){var T=N.getSelectedFilters($conversationToolbar.find(".toolbar-filter-overlay")),U={};U[P]=searchKeyword;A.extend(T,U);N.setOption("customFilter",T);N.forceApplyFilters();N.displayCustomFilterText(this.elements[P]);if(B.isEnabled()){Q=vBulletin.makePaginatedUrl(location.href,1);Q=vBulletin.makeFilterUrl(Q,P,searchKeyword,$conversationToolbar);B.pushState({from:"filter",page:1,tab:S?"#"+S:"",filters:T},document.title,Q)}}else{var R=$conversationToolbar.find('.filter-text[data-filter-name="{0}"]'.format(P));if(R.length){var T=N.getSelectedFilters($conversationToolbar.find(".toolbar-filter-overlay"));N.setOption("customFilter",T);A(".x",R).trigger("click");if(B.isEnabled()){var Q=vBulletin.makePaginatedUrl(location.href,1);Q=vBulletin.makeFilterUrl(Q,P,searchKeyword,$conversationToolbar);B.pushState({from:"filter",page:1,tab:S?"#"+S:"",filters:T},document.title,Q)}}}return false})}function M(P,Q){vBulletin.conversation.displaySelectedFilterText(P,Q,O.context)}H();this.isFilterSelected=function(P){return A('.toolbar-filter-overlay input[value="'+P+'"]',O.context).is(":checked")};this.getSelectedFilters=function(P){return vBulletin.getSelectedFilters(P,false)};this.resetFilterForms=function(P){if(!P||(P instanceof A&&!P.length)){P=O.context}A(".toolbar-filter-overlay .js-default-checked",P).prop("checked",true);A(".toolbar-search-form .js-filter-search",P).val("").filter(".placeholder").focus().blur()};A(".toolbar-filter-overlay, .toolbar-search-form",O.context).trigger("reset");if(B.isEnabled()){var D=B.getState();if(!D||A.isEmptyObject(D.data)){var G=A(O.context).hasClass("ui-tabs-panel")?A(O.context).attr("id"):A(".conversation-toolbar-wrapper",O.context).closest(".ui-tabs-panel").attr("id"),L={from:"filter",page:Number(A(".pagenav-form .defaultpage",O.context).val())||1,tab:G?"#"+G:"",filters:N.getSelectedFilters(A("form.toolbar-filter-overlay",O.context))};B.setDefaultState(L,document.title,location.href)}B.setStateChange(function(U,Y,W){var P=B.getState();if(P.data.from=="filter"||Y=="pagination"||Y=="tabs"){B.log(P.data,P.title,P.url);if(Y=="pagination"){if(W){var X=A(".filtered-by",O.context),Q=A(".toolbar-filter-overlay .filter-options-list",O.context),Z=false;A(".filter-text",X).filter('[data-filter-name!="q"]').remove();A(".clear-all",X).addClass("h-hide");Q.find(".js-default-checked").prop("checked",true);A.each(W,function(b,c){var a=A('input[name="{0}"][value="{1}"]'.format(b,c),Q);if(a.length){a.prop("checked",true).trigger("change",[true,P.data.page]);Z=true}});if(!Z){Q.first().data("bypass-filter-display",true).trigger("change",[true,P.data.page]).data("bypass-filter-display",null);X.addClass("h-hide")}}}else{var V=O.context instanceof A?O.context:A(O.context),T=V.closest(".ui-tabs"),R=T.find('.ui-tabs-nav > li > a[href*="{0}"]'.format(P.data.tab));if(!R.parent().hasClass("ui-tabs-selected")){var S=R.parent().index();vBulletin.selectTabByIndex.call(T,S)}else{N.setOption("context",A(P.data.tab));N.updatePageNumber(P.data.page);N.applyHistoryFilters(P.data)}}}},"filter")}this.displayCustomFilterText=function(P,Q){M(P,(Q||A(P).val()))};this.isHistoryEnabled=function(){return B.isEnabled()};this.resetFilters=function(P,X,R){var W=A(".filtered-by",R).addClass("h-hide"),Q=location.pathname.replace(/\/page[0-9]+/,"");if(!R||(R instanceof A&&!R.length)){R=O.context}var U=vBulletin.parseQueryString(location.search);if(U.tab){Q+="?tab="+U.tab}else{if(U.view){Q+="?view="+U.view}}A(".clear-all",W).addClass("h-hide");A(".filter-text",W).remove();N.resetFilterForms(R);if(!P){if(B.isEnabled()){W.data("reset",true);N.updatePageNumber(1);var T=N.getSelectedFilters(A("form.toolbar-filter-overlay",R));if(X){var V=A(".toolbar-search-form .js-filter-search",R).val("");delete T[V.attr("name")];N.setOption("customFilter",T)}N.forceApplyFilters();var S=W.closest(".ui-tabs-panel").attr("id");L={from:"filter",page:1,tab:S?"#"+S:"",filters:T};B.pushState(L,document.title,Q)}else{if(O.allowHistory){location.href=Q}}}return N};this.applyHistoryFilters=function(R){if(R&&R.filters&&!A.isEmptyObject(R.filters)){var S=A(R.tab),U=A(".toolbar-filter-overlay",S);if(typeof (N.lastFilters)!="undefined"){delete N.lastFilters}N.resetFilters(true,false,S);A.each(R.filters,function(V,X){var W=A('[name="'+V+'"]',U);if(W.attr("type")=="hidden"){W.val(X)}else{if(W.attr("type")=="radio"&&X!=R.filtervalue){W.filter('[value="'+X+'"]').prop("checked",true)}}});var Q=vBulletin.parseQueryString(location.href),T=true,P=function(){A(".toolbar-search-form .js-filter-search",S).val("").filter(".placeholder").focus().blur()};if(!A.isEmptyObject(Q)){A.each(Q,function(W,X){var V=A('.filter-options-list input[name="{0}"][value="{1}"]'.format(W,X),U);if(V.length){if(R.filtername==W&&R.filtervalue==X){T=false;V.prop("checked",true).trigger("change",[true])}else{M(V.get(0))}}else{V=A('.toolbar-search-form .search-container input[name="{0}"]'.format(W),S);if(V.length&&X){M(V.get(0),X);V.val(X)}else{P()}}})}else{P()}if(T){N.setOption("customFilter",R.filters);N.forceApplyFilters();N.setOption("customFilter",null)}}return N};this.forceApplyFilters=function(){if(typeof (N.lastFilters)!="undefined"){delete N.lastFilters}C=true;N.applyFilters(false,true);return N};this.applyFilters=function(V,Q,S,U){var P=A(".toolbar-filter-overlay",O.context);if(Q){clearTimeout(F)}var R={filters:(!O.customFilter)?N.getSelectedFilters(P):O.customFilter};if(A.isEmptyObject(R.filters)){return N}if(V){R.filters["checkSince"]=E;R.filters["pagenum"]=1}if(!U){var T=P.find('input[name="result-id"]').val(0);if(T.length){R.filters["result-id"]=0}}else{C=true}if(typeof (this.lastFilters)!="undefined"&&vBulletin.areJsonObjectsEqual(this.lastFilters.filters,R.filters)&&!V){return N}this.lastFilters=R;A(".conversation-toolbar-wrapper",O.context).addClass("h-disabled");A(".conversation-empty",O.context).addClass("h-invisible");if(V){window.vBulletin.loadingIndicator.suppressNextAjaxIndicator()}A.ajax({type:"post",url:vBulletin.normalizeAjaxUrl(P.attr("action"))||(vBulletin.getAjaxBaseurl()+"/activity/get"),data:(R),dataType:"json",success:function(W){A(".conversation-empty",O.context).addClass("h-hide");if(!W||W.error||W.errors){console.log("/activity/get failed. result:"+JSON.stringify(W));A(".conversation-list",O.context).addClass("h-hide");var Y="unknown_error";if(!W){Y="invalid_server_response_please_try_again"}else{if(W.error){Y=W.error}else{if(W.errors){Y=W.errors[0][0]}}}Y=vBulletin.phrase.get(Y);A(".conversation-empty",O.context).html((Y||"").replace(/<br\s*\/*>/g," ")).removeClass("h-hide h-invisible");return }if(V){if(!J&&W.total>0&&!A("body").hasClass("edit-mode")){A(".new-conversations-strip span",O.context).html(W.total);A(".new-conversations-strip",O.context).fadeIn("slow")}if(A(".conversation-list li.list-item",O.context).length==0){A(".conversation-empty",O.context).removeClass("h-hide")}}else{A(".new-conversations-strip",O.context).hide();if(((W.total_with_sticky>0)||(W.total>0))&&W.template){if(W.resultId){var Z=A('input[name="result-id"]',P).val(W.resultId);if(Z.length&&this.lastFilters){this.lastFilters.filters["result-id"]=W.resultId}if(O.pagination){O.pagination.updateResultId(W.resultId)}}if(S){A(".conversation-list",O.context).append(W.template)}else{A(".conversation-empty",O.context).addClass("h-hide");A(".conversation-list",O.context).html(W.template).removeClass("h-hide")}if(R.filters["pagenum"]>=R.filters["maxpages"]||R.filters["pagenum"]>=W.pageinfo.totalpages||W.pageinfo.showseemore===false){A(".conversation-showmore",O.context).addClass("h-hide")}else{A(".conversation-showmore",O.context).removeClass("h-hide")}}else{if(!S){A(".conversation-empty",O.context).removeClass("h-hide");A(".conversation-list",O.context).addClass("h-hide").empty()}}if(W.total_with_sticky==0){A(".conversation-showmore",O.context).addClass("h-hide")}if(C&&O.scrollToTop){var X=(O.scrollToTop instanceof A)?O.scrollToTop:A(O.scrollToTop);if(X.length>0){A("body,html").animate({scrollTop:X.offset().top},"slow")}}E=W.lastDate;if(typeof O.onContentLoad=="function"){O.onContentLoad.apply(A(".conversation-list",O.context).get(0),[W])}if(W.pageinfo){N.updatePageNumber(W.pageinfo.pagenumber||1);if(O.pagination&&typeof O.pagination.updatePageInfo=="function"){O.pagination.updatePageInfo(W.pageinfo,true)}}if(vBulletin.inlinemod&&typeof vBulletin.inlinemod.init=="function"&&A(".moderationmenu_container",O.context).length>0){vBulletin.inlinemod.init(O.context)}}if(J){J=false}},error:function(Y,X,W){console.log("/activity/get failed. error:"+W);if(W!=""){openAlertDialog({title:vBulletin.phrase.get("error"),message:vBulletin.phrase.get("unable_to_contact_server_please_try_again"),iconType:"error"})}},complete:function(){A(".conversation-toolbar-wrapper",O.context).removeClass("h-disabled");A(".conversation-empty",O.context).removeClass("h-invisible");if(!J&&O.autoCheck&&F){F=setTimeout(N.checkNewConversations,O.checkInterval)}}});return N};this.updatePageNumber=function(P){P=Number(P);if(P>0){A('form.toolbar-filter-overlay input[name="pagenum"]',O.context).val(P)}return N};this.checkNewConversations=function(){if(!A("body").hasClass("edit-mode")){console.log("Checking for new activity since "+E);N.applyFilters(true)}return N};this.toggleNewConversations=function(P){if(P){O.autoCheck=true;F=setTimeout(N.checkNewConversations,O.checkInterval)}else{O.autoCheck=false;clearTimeout(F)}return N};this.hideFilterOverlay=function(){A(".conversation-toolbar-wrapper .toolbar-filter-overlay",O.context).filter(":visible").each(function(){A(this).prev(".conversation-toolbar").find(".toolbar-filter").triggerHandler("click."+I,[0])});return N};this.getOption=function(P){return O[P]};this.setOption=function(P,Q){O[P]=Q;return N};if(O.autoCheck){E=pageData.current_server_datetime;F=setTimeout(N.checkNewConversations,O.checkInterval)}};vBulletin.conversation.displaySelectedFilterText=function(J,K,C){var L=A(J);C=C||L.closest(".conversation-toolbar-wrapper");var G=A(".filtered-by",C).removeClass("h-hide").find(".filter-text-wrapper").show(),B=A(".filter-text[data-filter-name={0}]".format(J.name),G),M='<div class="filter-text" data-filter-name="{0}" data-filter-value="{1}"><span title="{2}">{3}</span><span class="x vb-icon vb-icon-x-blue"></span></div>',E,F,I;if(J.type=="radio"){F=L.next("span").html();E=A(M.format(J.name,vBulletin.htmlEntities(J.value),L.closest(".filter-options").prev(".filter-header").html()+" - "+F,((J.name=="filter_new_topics"||J.name=="filter_depth"||J.name=="filter_prefix"||(J.value.indexOf("_all")!=-1&&J.value!="time_all"))?(L.closest("li").find(".filter-header").html()||"")+" - ":"")+F))}else{if(J.type=="text"){K="&quot;"+JShtmlEncode(K)+"&quot;";E=A(M.format(J.name,vBulletin.htmlEntities(J.value),L.data("filter-name")+": "+K,K)).data("filter-type","text");I=L.attr("class").match(/js-.*/);if(I){E.data("filter-js-selector","."+I[0])}}}if(B.length>0){B.replaceWith(E)}else{var D=[],H=false;A(".toolbar-filter-overlay > ul > li",C).each(function(){D.push(A("input:first",this).attr("name"))});A(".filter-text",G).each(function(){var N=A(this);if(A.inArray(J.name,D)<A.inArray(N.attr("data-filter-name"),D)){N.before(E);H=true;return false}});if(!H){G.append(E)}if(A(".filter-text",G).length>1){G.next(".clear-all").removeClass("h-hide")}}}})(jQuery);