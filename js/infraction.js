(function(B){window.vBulletin=window.vBulletin||{};window.vBulletin.phrase=window.vBulletin.phrase||{};window.vBulletin.phrase.precache=window.vBulletin.phrase.precache||[];window.vBulletin.phrase.precache=B.merge(window.vBulletin.phrase.precache,["error_adding_infraction","error_adding_warning","error_reversing_infraction","error_sending_private_message","give_infraction_ginfraction","infraction_added","infraction_reversed","please_check_the_box_to_reverse_infraction","please_specify_reason_to_reverse_infraction","received_infraction","received_warning","warning_added"]);vBulletin.infraction=vBulletin.infraction||{};vBulletin.infraction.infractUser=function(G,C){var H=B(this);if(H.data("ajaxstarted")){return false}var F=H.hasClass("infraction-received"),E,D;if(F){E="received_infraction_form";D="received_infraction"}else{E="give_infraction_form";D="give_infraction_ginfraction"}H.data("ajaxstarted",true);vBulletin.AJAX({url:vBulletin.getAjaxBaseurl()+"/ajax/render/"+E,data:{userid:H.data("userid"),nodeid:H.closest(".post-controls").data("node-id")||H.data("nodeid"),userInfraction:H.data("userinfraction")},error_phrase:"error_x",complete:function(){H.data("ajaxstarted",null)},success:function(I){var J=B(I);J.dialog({title:vBulletin.phrase.get(D),autoOpen:true,modal:true,resizable:false,closeOnEscape:false,showCloseButton:false,width:J.hasClass("error-infraction-dialog")?500:(F?600:700),dialogClass:"dialog-container infraction-dialog-container dialog-box",close:function(){var K=B(".js-editor",this);if(K.length&&vBulletin.ckeditor.editorExists(K)){vBulletin.ckeditor.destroyEditor(K)}B(this).dialog("destroy").remove()},open:function(){var N=this;if(!F){var R=B(".infraction-send-pm",N);vBulletin.ajaxForm.apply(B(N),[{dataType:"json",error_phrase:"error_adding_infraction",success:function(V,T,Z,b){console.log("Infraction result:");console.dir(V);var a=(V.infractionNodeid&&!V.infractionNodeid.errors),X=(V.pmNodeid?1:0),Y=(V.pmNodeid&&!V.pmNodeid.errors),W="",U="warning";if(a&&(!X||Y)){W=V.isWarning?"warning_added":"infraction_added";U=""}else{if(a&&X&&!Y){W="error_sending_private_message"}else{W=V.isWarning?"error_adding_warning":"error_adding_infraction"}}openAlertDialog({title:vBulletin.phrase.get("give_infraction_ginfraction"),message:vBulletin.phrase.get(W),iconType:U});if(a){if(typeof C=="function"){C.apply(H.get(0),[V])}B(N).dialog("close")}},beforeSerialize:function(T){},beforeSubmit:function(X,V,d){var c=B(".infraction-level-control option:selected",V).val();if(c=="0"){if(B.trim(B(".custom-reason",V).val())==""){P(B(".infraction-level",N));openAlertDialog({title:vBulletin.phrase.get("give_infraction_ginfraction"),message:vBulletin.phrase.get("please_specify_custom_reason"),iconType:"warning",onAfterClose:function(){B(".custom-reason",V).focus()}});return false}var b=Number(B(".custom-points",V).val());if(isNaN(b)||b<=0){P(B(".infraction-level",N));openAlertDialog({title:vBulletin.phrase.get("give_infraction_ginfraction"),message:vBulletin.phrase.get("please_specify_custom_points"),iconType:"warning",onAfterClose:function(){B(".custom-points",V).focus()}});return false}var Z=B(".custom-period option:selected",V).val(),T=Number(B(".custom-expires",V).val());if(Z!="N"&&(isNaN(T)||T<=0)){P(B(".infraction-level",N));openAlertDialog({title:vBulletin.phrase.get("give_infraction_ginfraction"),message:vBulletin.phrase.get("please_specify_custom_expires"),iconType:"warning",onAfterClose:function(){B(".custom-expires",V).focus()}});return false}}var U=B(".infraction-ban-reason .ban-reason",N);if(U.is(":visible")&&!B.trim(U.val())){P(B(".infraction-ban",N));B(".ban-reason-desc",N).removeClass("h-hide");U.focus();B(".dialog-content",N).scrollTop(0).scrollTop(B(".infraction-ban-reason",N).position().top);return false}var W=Number(R.data("required"));if(W){var a=false,Y=B(".js-editor",V);if(vBulletin.ckeditor.editorExists(Y)){Y=vBulletin.ckeditor.getEditor(Y);if(!B.trim(Y.getData())){a=true}}else{if(!B.trim(Y.val())){a=true}}if(a){openAlertDialog({title:vBulletin.phrase.get("give_infraction_ginfraction"),message:vBulletin.phrase.get("please_specify_infraction_pm"),iconType:"warning",onAfterClose:function(){P(R);Y.focus()}});return false}}}}]);var M=function(T){if(T){L.removeClass("h-hide").find("input, select").prop("disabled",false).end().find(".selectBox").removeClass("selectBox-disabled")}else{L.addClass("h-hide").find("input, select").prop("disabled",true).end().find(".selectBox").addClass("selectBox-disabled")}};B(".infraction-level-control",N).on("change",function(X,W,V){var Z=B(this.options[this.selectedIndex]),V=V&&V.length==1?V:B(this).closest(".infraction-level").find(".infraction-warning-control input");if(!W){if(Z.data("allow-warning")){V.prop("disabled",false).val(this.value).parent().removeClass("h-hide");M(false)}else{V.prop("disabled",true).parent().addClass("h-hide");if(this.value=="0"){M(true);B(".textbox",L).first().focus()}}}var Y=0,T=0;if(!V.prop("checked")&&this.value!="0"){Y=Number(Z.data("points"))||0;T=1}else{if(this.value=="0"){Y=Number(B(".custom-infraction-info .custom-points",N).val())||0;T=1}}var U=B(".infraction-dashboard-stats").data();if(O(Number(U.points)+Y,Number(U.infractions)+T)){Q(true)}else{Q(false)}K()});B(".infraction-warning-control input",N).on("click",function(){(this.checked)?Q(false):B(".infraction-level-control",N).trigger("change",[true,this])});B(".custom-points",N).on("change",function(){B(".infraction-level-control",N).trigger("change",[true])});var L=B(".custom-infraction-info",N).removeClass("h-hide");B("select",N).selectBox();L.addClass("h-hide");B(".js-content-entry-panel, .js-editor",R).data("callback",function(){K()});vBulletin.ckeditor.initEditorComponents(R,true);B(".toggle-button",N).on("click",function(X){var V=B(this),T=V.closest(".blockrow-head"),W=T.next(".blockrow-body");if(V.hasClass("expand")){W.show();T.removeClass("collapsed");K()}else{W.hide();T.addClass("collapsed");K()}V.toggleClass("collapse expand");var U=V.attr("title");V.attr("title",V.data("toggle-title")).data("toggle-title",U);return false});var P=function(T){B(".toggle-button.expand",T).trigger("click")};var O=function(U,T){if(U==0&&T==0){return false}var V=false;B(".infraction-ban-list tbody tr",N).each(function(W,X){var Y=B(this).data();if((Y&&Number(Y.points)&&U>=Number(Y.points))||(Y&&Number(Y.infractions)&&T>=Number(Y.infractions))){V=true;return false}});return V};var Q=function(T){var U=B(".infraction-ban-reason",N);if(T){U.removeClass("h-hide");P(B(".infraction-ban",N))}else{U.addClass("h-hide")}};var S=B(".dialog-content",N),K=function(){S[(S[0].scrollHeight>parseFloat(S.css("max-height")))?"addClass":"removeClass"]("has-scrollbar")};K();B(".infraction-level-control",N).trigger("change")}else{vBulletin.ajaxForm.apply(B(".infraction-reverse-form",N),[{dataType:"json",error_phrase:"error_reversing_infraction",success:function(U,V,W,T){openAlertDialog({title:vBulletin.phrase.get("reverse_this_infraction"),message:vBulletin.phrase.get("infraction_reversed")});if(typeof C=="function"){C.apply(H.get(0),[U])}B(N).dialog("close")},beforeSerialize:function(T){},beforeSubmit:function(V,U,T){if(!B(".infraction-nodeid",U).is(":checked")){openAlertDialog({title:vBulletin.phrase.get("reverse_this_infraction"),message:vBulletin.phrase.get("please_check_the_box_to_reverse_infraction"),iconType:"warning",onAfterClose:function(){B(".infraction-nodeid",U).focus()}});return false}else{if(!B.trim(B(".infraction-reason",U).val())){openAlertDialog({title:vBulletin.phrase.get("reverse_this_infraction"),message:vBulletin.phrase.get("please_specify_reason_to_reverse_infraction"),iconType:"warning",onAfterClose:function(){B(".infraction-reason",U).focus()}});return false}}return true}}]);B(".reverse-infraction",N).on("click",function(){B(".infraction-reverse-form",N).submit()})}B(".close-infraction",N).on("click",function(){B(N).dialog("close")});B(".ckeditor-bare-box.ckeditor-load-on-focus",N).on("focus",function(){vBulletin.ckeditor.initEditor(this.id,{complete:function(T){K()},error:function(T){B("#"+T).prop("disabled",false).removeClass("ckeditor-load-on-focus")}})})}})}})};vBulletin.infraction.loadUserInfractions=function(C){B.post(vBulletin.getAjaxBaseurl()+"/ajax/render/user_infractions",{userid:C.userid,pagenum:C.pageNumber},function(D,G,F){C.container.html(D);if(B(".pagenav-form",A).length){var E=vBulletin.pagination({context:A,onPageChanged:function(H,I){vBulletin.infraction.loadUserInfractions({container:A,userid:A.data("userid"),pageNumber:H})}})}if(typeof C.callback=="function"){C.callback(D)}},"json")};B(document).off("click",".post-footer .infractionCtrl").on("click",".post-footer .infractionCtrl",function(C){vBulletin.infraction.infractUser.apply(this,[C,function(D){var F=B(this),E=F.hasClass("infraction-received");if(E){F.removeClass("infraction-received infraction-warning").attr("title",vBulletin.phrase.get("give_infraction_ginfraction"))}else{F.addClass("infraction-received");if(D.isWarning){F.addClass("infraction-warning").attr("title",vBulletin.phrase.get("received_warning"))}else{F.attr("title",vBulletin.phrase.get("received_infraction"))}}}])});var A=B("#infractions-tab");A.off("click",".infractionCtrl").on("click",".infractionCtrl",function(C){vBulletin.infraction.infractUser.apply(this,[C,function(D){vBulletin.infraction.loadUserInfractions({container:A,userid:B(this).data("userid"),pageNumber:1})}])});A.on("click",".view-infraction",function(C){vBulletin.infraction.infractUser.apply(this,[C,function(D){vBulletin.infraction.loadUserInfractions({container:A,userid:B(this).data("userid"),pageNumber:B('.pagenav-form input[name="page"]').val()||1})}])})})(jQuery);